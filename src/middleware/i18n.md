# i18n Middleware

The `i18n` utility is a lightweight internationalization factory for **Hono** applications and background tasks (like Cloudflare Queues). It provides a type-safe translation function `t()` that supports nested keys, variable interpolation, and automatic language fallbacks.

---

## Features

- **Nested Key Resolution:** Access translations using dot notation (e.g., `errors.auth.invalid_password`).
- **Variable Interpolation:** Inject dynamic values into strings using `{{variable}}` syntax.
- **Contextual Flexibility:** Includes both a Hono middleware and a standalone `queue` factory for non-request environments.
- **Fallback Logic:** Automatically reverts to a `defaultLanguage` if a key is missing in the requested locale.
- **TypeScript Optimized:** Infers translation shapes to help prevent missing key errors during development.

---

## Quick Start

### 1. Prepare Translations

Define your dictionary with a consistent structure across languages.

```typescript
const translations = {
  en: {
    welcome: 'Hello, {{name}}!',
    auth: { login: 'Sign in' },
  },
  pl: {
    welcome: 'Witaj, {{name}}!',
    auth: { login: 'Zaloguj siÄ™' },
  },
};
```

### 2. Integration with Hono

The middleware requires a `language` variable to be set in the context _before_ it is executed.

```typescript
import { Hono } from 'hono';
import { i18n } from './i18n';

const app = new Hono();

// 1. Set language (e.g., based on headers or cookies)
app.use('*', async (c, next) => {
  c.set('language', 'en');
  await next();
});

// 2. Register i18n middleware
const { middleware } = i18n(translations, 'en');
app.use('*', middleware);

// 3. Use in routes
app.get('/', (c) => {
  const message = c.var.t('welcome', { name: 'User' });
  return c.text(message); // "Hello, User!"
});
```

---

## API Reference

### `i18n(translations, defaultLanguage)`

The main factory function.

- **`translations`**: An object containing your language keys.
- **`defaultLanguage`**: The fallback locale (e.g., `'en'`).

### `t(input, params?, overrideLanguage?)`

The translation function injected into `c.var.t` or returned by the queue factory.

| Argument           | Type                   | Description                                                   |
| ------------------ | ---------------------- | ------------------------------------------------------------- | -------------------------------------------- |
| `input`            | `string`               | The dot-notated path to the translation (e.g., `'nav.home'`). |
| `params`           | `Record<string, string | number>`                                                      | Optional object for `{{key}}` interpolation. |
| `overrideLanguage` | `string`               | Optional locale to use for this specific call only.           |

### `queue(language?)`

A factory for using translations outside of the HTTP request lifecycle (e.g., in CRON jobs or Queues).

```typescript
const { queue } = i18n(translations, 'en');
const t = queue('pl');
console.log(t('welcome', { name: 'Admin' })); // "Witaj, Admin!"
```

---

## Technical Details

### Key Resolution Logic

The utility resolves keys via a recursive `reduce` function. If a path is provided (e.g., `a.b.c`), it traverses the translation object for the active language. If the key is not found at the destination, it attempts the same traversal in the `defaultLanguage`. If both fail, it returns the raw `input` string as a safety fallback.

### Variable Interpolation

Interpolation is performed via a global Regex:

```typescript
acc.replace(new RegExp(`{{${key}}}`, 'g'), params[key].toString());
```

---

> [!CAUTION]
> **Middleware Order:** The `i18n` middleware will throw an Error if `c.var.language` is undefined. Ensure your language detection middleware (cookies, `Accept-Language` header, etc.) runs before this middleware.
